<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bacha Mario BOSS 300</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Arial', sans-serif; touch-action: manipulation; }
        canvas { display: block; }
        #ui { position: absolute; top: 10px; left: 10px; color: white; text-shadow: 2px 2px 4px #000; pointer-events: none; }
        #boss-hp { position: absolute; top: 10px; right: 10px; color: #ff0000; font-weight: bold; font-size: 20px; }
    </style>
</head>
<body>

<div id="ui">–û—á–∫–∏: <span id="score">0</span></div>
<div id="boss-hp"></div>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —ç–∫—Ä–∞–Ω
function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let score = 0;
let lastTime = 0;
let player = { x: 50, y: 0, w: 50, h: 80, vy: 0, jump: -17, ground: false }; // –£–≤–µ–ª–∏—á–µ–Ω –ø—Ä—ã–∂–æ–∫ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
let mobs = [];
let coins = [];
let boss = { 
    active: false, 
    x: 0, 
    y: 0, 
    w: 180, 
    h: 220, 
    hp: 5, 
    speed: 3, 
    state: 'enter',
    hitTimer: 0 
};

// –ö–∞—Ä—Ç–∏–Ω–∫–∏
const pImg = new Image(); pImg.src = 'player.png';
const mImg = new Image(); mImg.src = 'mob.png';
const cImg = new Image(); cImg.src = 'coin.png';
const bImg = new Image(); bImg.src = 'boss.png';

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
window.addEventListener('touchstart', () => { if(player.ground) { player.vy = player.jump; player.ground = false; } });
window.addEventListener('keydown', (e) => { if(e.code === 'Space' && player.ground) { player.vy = player.jump; player.ground = false; } });

function update(time) {
    let dt = time - lastTime;
    lastTime = time;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è –∏ –∏–≥—Ä–æ–∫
    player.vy += 0.8;
    player.y += player.vy;
    if(player.y > canvas.height - 120) { 
        player.y = canvas.height - 120; 
        player.vy = 0; 
        player.ground = true; 
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä–æ–∫–∞
    ctx.drawImage(pImg, player.x, player.y, player.w, player.h);

    // –õ–û–ì–ò–ö–ê –ë–û–°–°–ê
    if (score >= 300 && !boss.active && boss.hp > 0) {
        boss.active = true;
        boss.x = canvas.width + 100;
        boss.y = canvas.height - 260;
    }

    if (boss.active) {
        document.getElementById("boss-hp").innerText = "HP –ë–û–°–°–ê: " + "‚ù§Ô∏è".repeat(boss.hp);
        
        if (boss.state === 'enter') {
            boss.x -= 2;
            if (boss.x < canvas.width - 250) boss.state = 'fight';
        } else if (boss.state === 'fight') {
            boss.x -= boss.speed;
            if (boss.x < 20 || boss.x > canvas.width - 250) boss.speed *= -1;
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –±–æ—Å—Å–∞ —Å –º–∏–≥–∞–Ω–∏–µ–º –ø—Ä–∏ —É–¥–∞—Ä–µ
        ctx.save();
        if (boss.hitTimer > 0) {
            ctx.globalAlpha = 0.5;
            boss.hitTimer--;
        }
        if (bImg.complete && bImg.naturalWidth !== 0) {
            ctx.drawImage(bImg, boss.x, boss.y, boss.w, boss.h);
        } else {
            ctx.fillStyle = "darkred";
            ctx.fillRect(boss.x, boss.y, boss.w, boss.h);
        }
        ctx.restore();

        // –°–¢–û–õ–ö–ù–û–í–ï–ù–ò–ï –° –ë–û–°–°–û–ú (–ò–°–ü–†–ê–í–õ–ï–ù–û)
        let hitX = player.x < boss.x + boss.w - 40 && player.x + player.w > boss.x + 40;
        let hitY = player.y < boss.y + boss.h && player.y + player.h > boss.y;

        if (hitX && hitY) {
            // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –ø–∞–¥–∞–µ—Ç —Å–≤–µ—Ä—Ö—É –Ω–∞ –≤–µ—Ä—Ö–Ω—é—é —á–∞—Å—Ç—å –±–æ—Å—Å–∞
            if (player.vy > 0 && (player.y + player.h) < (boss.y + boss.h / 2 + 40)) {
                boss.hp -= 1;
                boss.hitTimer = 15;
                player.vy = -18; // –ú–æ—â–Ω—ã–π –æ—Ç—Å–∫–æ–∫ –≤–≤–µ—Ä—Ö
                boss.x += 100;   // –ë–æ—Å—Å –æ—Ç–ª–µ—Ç–∞–µ—Ç –Ω–∞–∑–∞–¥
                
                if (boss.hp <= 0) {
                    boss.active = false;
                    score += 500;
                    document.getElementById("boss-hp").innerText = "–ü–û–ë–ï–î–ê! üî•";
                }
            } else if (boss.hitTimer === 0) {
                // –ï—Å–ª–∏ –Ω–µ –ø—Ä—ã–≥–Ω—É–ª —Å–≤–µ—Ä—Ö—É –∏ –±–æ—Å—Å –Ω–µ –≤ –æ—Ç–∫–∞—Ç–µ –æ—Ç —É–¥–∞—Ä–∞ ‚Äî —Ä–µ—Å—Ç–∞—Ä—Ç
                location.reload();
            }
        }
    } else {
        // –ï—Å–ª–∏ –±–æ—Å—Å–∞ –Ω–µ—Ç ‚Äî —Å–ø–∞–≤–Ω–∏–º –æ–±—ã—á–Ω—ã—Ö –º–æ–±–æ–≤
        if(Math.random() < 0.015 && (mobs.length === 0 || mobs[mobs.length-1].x < canvas.width - 400)) {
            mobs.push({ x: canvas.width, y: canvas.height - 115, w: 60, h: 75 });
        }
    }

    // –ú–æ–±—ã
    mobs.forEach((m, i) => {
        m.x -= 6;
        ctx.drawImage(mImg, m.x, m.y, m.w, m.h);
        // –°–º–µ—Ä—Ç—å –æ—Ç –º–æ–±–∞
        if(player.x < m.x + m.w - 10 && player.x + player.w > m.x + 10 && player.y + player.h > m.y + 10) {
            if(player.vy > 0) { // –£–±–∏—Ç—å –º–æ–±–∞ –ø—Ä—ã–∂–∫–æ–º
                mobs.splice(i, 1);
                score += 10;
                player.vy = -12;
            } else {
                location.reload();
            }
        }
        if(m.x < -100) mobs.splice(i, 1);
    });

    // –ú–æ–Ω–µ—Ç–∫–∏
    if(Math.random() < 0.02) coins.push({ x: canvas.width, y: canvas.height - 150 - Math.random() * 150, w: 40, h: 40 });
    coins.forEach((c, i) => {
        c.x -= 5;
        if (cImg.complete) ctx.drawImage(cImg, c.x, c.y, c.w, c.h);
        if(player.x < c.x + c.w && player.x + player.w > c.x && player.y < c.y + c.h && player.y + player.h > c.y) {
            coins.splice(i, 1);
            score += 5;
        }
        if(c.x < -100) coins.splice(i, 1);
    });

    document.getElementById("score").innerText = score;
    requestAnimationFrame(update);
}

requestAnimationFrame(update);
</script>
</body>
</html>
