<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bacha Mario: Back to Bachkari</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: sans-serif; touch-action: manipulation; }
        canvas { display: block; }
        #ui { position: absolute; top: 10px; left: 10px; color: white; font-size: 24px; text-shadow: 2px 2px 2px #000; pointer-events: none; }
        #boss-hp { position: absolute; top: 10px; right: 10px; color: red; font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="ui">Очки: <span id="score">0</span></div>
    <div id="boss-hp"></div>
    <canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// Состояния игры
let score = 0;
let worldState = 'surface'; // 'surface' или 'underground'
let gameActive = true;

let player = { 
    x: 100, y: 0, w: 50, h: 80, 
    vy: 0, jump: -16, ground: false 
};

let boss = {
    active: false,
    hp: 5,
    x: 0, y: 0, w: 160, h: 200,
    speed: 3,
    hitTimer: 0
};

let mobs = [];
let coins = [];

// Картинки (заглушки, если файлов нет)
const pImg = new Image(); pImg.src = 'player.png';
const mImg = new Image(); mImg.src = 'mob.png';
const cImg = new Image(); cImg.src = 'coin.png';
const bImg = new Image(); bImg.src = 'boss.png';

// Управление
const jumpAction = () => { if(player.ground) { player.vy = player.jump; player.ground = false; } };
window.addEventListener('touchstart', (e) => { e.preventDefault(); jumpAction(); }, {passive: false});
window.addEventListener('keydown', (e) => { if(e.code === 'Space') jumpAction(); });

function update() {
    if (!gameActive) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 1. Гравитация
    player.vy += 0.7;
    player.y += player.vy;
    let groundY = canvas.height - 100;

    if (player.y > groundY - player.h) {
        player.y = groundY - player.h;
        player.vy = 0;
        player.ground = true;
    }

    // 2. Отрисовка игрока
    ctx.drawImage(pImg, player.x, player.y, player.w, player.h);

    // 3. Логика Босса (появление на 300 очках)
    if (score >= 300 && boss.hp > 0 && worldState === 'surface') {
        if (!boss.active) {
            boss.active = true;
            boss.x = canvas.width + 100;
            boss.y = groundY - boss.h;
        }

        boss.x -= boss.speed;
        if (boss.x < 50 || boss.x > canvas.width - boss.w) boss.speed *= -1;

        // Рисуем босса
        ctx.save();
        if (boss.hitTimer > 0) { ctx.globalAlpha = 0.5; boss.hitTimer--; }
        ctx.drawImage(bImg, boss.x, boss.y, boss.w, boss.h);
        ctx.restore();
        document.getElementById("boss-hp").innerText = "БОСС: " + "❤️".repeat(boss.hp);

        // Столкновение с боссом
        let hitX = player.x < boss.x + boss.w - 30 && player.x + player.w > boss.x + 30;
        let hitY = player.y + player.h > boss.y && player.y < boss.y + boss.h;

        if (hitX && hitY) {
            // Прыжок сверху (упрощенная зона)
            if (player.vy > 0 && player.y + player.h < boss.y + 60) {
                boss.hp--;
                boss.hitTimer = 20;
                player.vy = -15; // Отскок
                boss.x += 100;   // Отброс босса
                if (boss.hp <= 0) {
                    boss.active = false;
                    document.getElementById("boss-hp").innerText = "ПАДАЕМ В БАЧКАРИ...";
                    startTransition();
                }
            } else if (boss.hitTimer === 0) {
                location.reload();
            }
        }
    }

    // 4. Мобы и монеты
    let moveDir = (worldState === 'surface') ? -5 : 5;

    // Спавн
    if (!boss.active && Math.random() < 0.015) {
        if (worldState === 'surface') {
            mobs.push({ x: canvas.width + 50, y: groundY - 70, w: 60, h: 70 });
        } else {
            mobs.push({ x: -100, y: groundY - 70, w: 60, h: 70 });
        }
    }

    mobs.forEach((m, i) => {
        m.x += moveDir;
        ctx.drawImage(mImg, m.x, m.y, m.w, m.h);
        
        // Столкновение с мобом
        if (player.x < m.x + m.w - 10 && player.x + player.w > m.x + 10 && player.y + player.h > m.y) {
            if (player.vy > 0) {
                mobs.splice(i, 1);
                score += 10;
                player.vy = -10;
            } else {
                location.reload();
            }
        }
    });

    // 5. Лимиты экрана для игрока в подземелье
    if (worldState === 'underground') {
        if (player.x < 0) player.x = 0;
        if (player.x > canvas.width - player.w) player.x = canvas.width - player.w;
    }

    document.getElementById("score").innerText = score;
    requestAnimationFrame(update);
}

function startTransition() {
    setTimeout(() => {
        worldState = 'underground';
        document.body.style.background = "#1a1a2e"; // Цвет подземелья
        mobs = [];
        player.x = canvas.width - 150; // Игрок теперь справа, идет налево
        player.jump = -18; // В подземелье прыгаем выше
        score += 500;
    }, 2000);
}

requestAnimationFrame(update);
</script>
</body>
</html>
